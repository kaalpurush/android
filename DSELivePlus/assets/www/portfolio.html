<!DOCTYPE html> 
<html> 
	<head> 
	<title>DSELive</title>	
	<meta name="viewport" content="width=320, initial-scale=1; user-scalable=no;"> 
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<style>
		.clear{clear:both;}
		body{font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size: 12px;margin:0px;padding:0px;}
		.hidden{display:none;}
		.popup{
			position: fixed;
			background:#F0F0F0;
			padding: 10px;
			z-index: 100;			
			overflow: hidden;
			font-size: 15px;
		}
		.popupwin{			
			margin: 0;			
			top: 0;
			left: 0;			
			width: 100%;
			height: 100%;
		}
		.popupmenu{
			border: 1px solid #4181A5;
			border-radius: 8px 8px 8px 8px;
			margin: 0 10px 10px 0;
			box-shadow: 0 4px 12px -3px black;
			position: fixed;
			top: 50%;
			left: 50%;
			width: 50%;
			height: auto;	
			text-align:center;
		}
		.popupmenu ul{list-style:none;padding:0;}
		.popupmenu li{border:1px solid black;margin-bottom:10px;padding:5px 0px;}
		.popupmenu li:hover,.popupmenu li:active{border:1px solid blue;}
		table {
			background-color: whiteSmoke;
			border-radius: 6px;
			-webkit-border-radius: 6px;
			-moz-border-radius: 6px;
		}
		table th {
			padding:2px;
			text-align: center;
			background: #202122;
			color: white;
			font-size: 12px;
			font-style: normal;
			font-weight: normal;
		}
		table td {
			text-align: center;
			line-height: 20px;
			color: black;
			border: 1px solid #fff;
		}
		.stat-box{
			border: 1px solid black;
			background: #2F9F00;
			overflow:hidden;
			margin: 5px 5px 5px 0;
			height: auto;
			width: auto;
			border-radius:3px;
			float: left;
			padding: 3px;
			color: white;
			font-weight: bold;
			font-size: 14px;
		}
		.stat-box div{text-align: center;}	
		.green{background:#0ACC0A;}
		.red{background:#F83939;}
	</style>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="jquery.json.js"></script>
	<script type="text/javascript">
	 var symbols=["1JANATAMF","1STBSRS","1STPRIMFMF","4THICB","5THICB","6THICB","8THICB","AAMRATECH","ABB1STMF","ABBANK","ACI","ACIFORMULA","ACIZCBOND","ACTIVEFINE","AFTABAUTO","AGNISYSL","AGRANINS","AIBL1STIMF","AIMS1STMF","AL-HAJTEX","ALARABANK","ALLTEX","AMBEEPHA","AMCL(PRAN)","ANLIMAYARN","ANWARGALV","APEXADELFT","APEXFOODS","APEXSPINN","APEXTANRY","ARAMIT","ARAMITCEM","ASIAINS","ASIAPACINS","ATLASBANG","AZIZPIPES","BANGAS","BANKASIA","BATASHOE","BATBC","BAYLEASING","BDAUTOCA","BDCOM","BDFINANCE","BDLAMPS","BDTHAI","BDWELDING","BEACHHATCH","BEACONPHAR","BEDL","BERGERPBL","BEXIMCO","BGIC","BIFC","BRACBANK","BRACSCBOND","BSC","BSCCL","BSRMSTEEL","BXPHARMA","BXSYNTH","CENTRALINS","CITYBANK","CITYGENINS","CMCKAMAL","CONFIDCEM","CONTININS","CVOPRL","DACCADYE","DAFODILCOM","DBH","DBH1STMF","DELTALIFE","DELTASPINN","DESCO","DESHBANDHU","DHAKABANK","DHAKAINS","DSHGARME","DULAMIACOT","DUTCHBANGL","EASTERNINS","EASTLAND","EBL","EBL1STMF","ECABLES","EHL","EXIMBANK","FAREASTLIF","FASFIN","FBFIF","FEDERALINS","FINEFOODS","FIRSTSBANK","FLEASEINT","FUWANGCER","FUWANGFOOD","GBBPOWER","GEMINISEA","GLOBALINS","GOLDENSON","GP","GPHISPAT","GQBALLPEN","GRAMEEN1","GRAMEENS2","GREENDELMF","GREENDELT","GSPFINANCE","HEIDELBCEM","HRTEX","IBBLPBOND","IBNSINA","ICB","ICB1STNRB","ICB2NDNRB","ICB3RDNRB","ICBAMCL1ST","ICBAMCL2ND","ICBEPMF1S1","ICBIBANK","ICBISLAMIC","IDLC","IFIC","IFIC1STMF","IFILISLMF1","ILFSL","IMAMBUTTON","INTECH","IPDC","ISLAMIBANK","ISLAMICFIN","ISLAMIINS","ISNLTD","JAMUNABANK","JAMUNAOIL","JANATAINS","JUTESPINN","KARNAPHULI","KAY&QUE","KEYACOSMET","KOHINOOR","KPCL","LAFSURCEML","LANKABAFIN","LEGACYFOOT","LIBRAINFU","LRGLOBMF1","MAKSONSPIN","MALEKSPIN","MARICO","MBL1STMF","MEGCONMILK","MEGHNACEM","MEGHNALIFE","MEGHNAPET","MERCANBANK","MERCINS","METROSPIN","MICEMENT","MIDASFIN","MIRACLEIND","MITHUNKNIT","MJLBD","MODERNDYE","MONNOCERA","MPETROLEUM","MTBL","NATLIFEINS","NAVANACNG","NBL","NCCBANK","NCCBLMF1","NHFIL","NITOLINS","NORTHRNINS","NPOLYMAR","NTC","NTLTUBES","OCL","OLYMPIC","ONEBANKLTD","ORIONINFU","PADMALIFE","PADMAOIL","PARAMOUNT","PEOPLESINS","PF1STMF","PHARMAID","PHENIXINS","PHOENIXFIN","PHPMF1","PIONEERINS","PLFSL","POPULAR1MF","POPULARLIF","POWERGRID","PRAGATIINS","PREMIERBAN","PREMIERLEA","PRIME1ICBA","PRIMEBANK","PRIMEFIN","PRIMEINSUR","PRIMELIFE","PRIMETEX","PROVATIINS","PUBALIBANK","QSMDRYCELL","RAHIMAFOOD","RAKCERAMIC","RANFOUNDRY","RDFOOD","RELIANCE1","RELIANCINS","RENATA","RENWICKJA","REPUBLIC","RNSPIN","RUPALIBANK","RUPALIINS","RUPALILIFE","SAFKOSPINN","SAIHAMCOT","SAIHAMTEX","SALAMCRST","SALVOCHEM","SAMORITA","SANDHANINS","SAPORTL","SEBL1STMF","SHAHJABANK","SIBL","SINGERBD","SINOBANGLA","SONALIANSH","SONARBAINS","SONARGAON","SOUTHEASTB","SPCERAMICS","SQUARETEXT","SQURPHARMA","STANDARINS","STANDBANKL","SUMITPOWER","TAKAFULINS","TALLUSPIN","TITASGAS","TRUSTB1MF","TRUSTBANK","UCBL","ULC","UNIONCAP","UNIQUEHRL","UNITEDAIR","UNITEDINS","UTTARABANK","UTTARAFIN","ZAHINTEX"];
	var portfolio,realized;
	var html='';
	
	$(function(){
		try{portfolio=jsInterface.getSetting("portfolio");}catch(e){portfolio='[{"buy_time":"1355579401321","symbol":"ABBANK","buy_price":"2","number":"4","buy_fee":"1"}]';}
		
		portfolio=$.parseJSON(portfolio);
		
		try{realized=jsInterface.getSetting("realized");}catch(e){realized='[{"buy_time":"1355579401321","sell_time":"1355579401321","symbol":"ABBANK","buy_price":"20","sell_price":"30","number":"2","buy_fee":"1","sell_fee":"1"}]';}
		
		realized=$.parseJSON(realized);
		
		for(i in symbols){
			html+='<option value="'+symbols[i]+'">'+symbols[i]+'</option>';			
		}
		$("#symbol").html(html);
		
		process_portfolio();
		process_realized();
	});
	
	function buy_share(me){
		var share=new Object();
		share.buy_time=new Date().getTime();
		share.symbol=$("#divbuy #symbol option:selected").val();
		share.number=$("#divbuy #number").val();
		share.buy_price=$("#divbuy #price").val();
		share.buy_fee=$("#divbuy #fee").val();
		share.buy_fee=share.buy_fee/share.number
		portfolio.push(share);
		save_portfolio();
		$("#divbuy").hide();
		return true;
	}
	
	function show_buy_share(){
		$(".popup").hide();
		$('#divbuy').show();
	}
	
	function save_portfolio(){
		jsInterface.putSetting("portfolio",$.toJSON(portfolio));	
	}
	
	function save_realized(){
		jsInterface.putSetting("realized",$.toJSON(realized));	
	}
	
	function process_portfolio(){
		html='<table width="100%" id="tblportfolio"><tr><th>Symbol</br>Qty</th><th>Buy</br>Fee</th><th>Total Cost</th><th>Current Price</br>Total Value</th><th>Gain</th><th><input type="button" onclick="show_buy_share();" value="+" /></th></tr>';
		var s_t_c=0,s_t_v=0,s_t_g=0,t_s=0;
		for(i in portfolio){			
			var p=portfolio[i];
			var buy_price=parseFloat(p.buy_price);
			var buy_fee=parseFloat(p.buy_fee)*parseInt(p.number);			
			if(!isNaN(parseInt(p.number)))
				t_s+=parseInt(p.number);
			try{var c_p=parseFloat(jsInterface.getPrice(p.symbol));}catch(e){c_p=1;}
			var t_c=buy_price*p.number+buy_fee;
			if(!isNaN(t_c))
				s_t_c+=t_c;
			var t_v=c_p*p.number;
			if(!isNaN(t_v))
				s_t_v+=t_v;
			var t_g=t_v-t_c;
			if(!isNaN(t_g))
				s_t_g+=t_g;
			
			s_t_g_p=(s_t_g/s_t_c)*100;
			
			var bg;			
			if(t_g>0) bg='green'; else bg='red';
			
			html+='<tr class="'+bg+'"><td>'+p.symbol+'</br>'+p.number+'</td><td>'+buy_price.toFixed(2)+'</br>'+buy_fee.toFixed(2)+'</td><td>'+t_c.toFixed(2)+'</td><td>'+c_p.toFixed(2)+'</br>'+t_v.toFixed(2)+'</td><td>'+t_g.toFixed(2)+'</td><td><input type="button" onclick="show_share_options(this);" value="*" /></td></tr>';
		}
		html+='</table>';
		$("#divportfolio").html(html);
		$("#page_portfolio .stat-box:eq(0) div").text(t_s);
		$("#page_portfolio .stat-box:eq(1) div").text(s_t_c.toFixed(2));
		$("#page_portfolio .stat-box:eq(2) div").text(s_t_v.toFixed(2));
		$("#page_portfolio .stat-box:eq(3) div").text(s_t_g.toFixed(2)+' ('+s_t_g_p.toFixed(2)+'%)');
	}
	
	function process_realized(){
		html='<table width="100%" id="tblrealized"><tr><th>Symbol</br>Qty</th><th>Buy Date</br>Cost</th><th>Sell Date</br>Value</th><th>Realized Gain</th><th> </th></tr>';
		var s_t_c=0,s_t_v=0,s_t_g=0,t_s=0;
		for(i in realized){			
			var p=realized[i];
			var buy_price=parseFloat(p.buy_price);
			var buy_fee=parseFloat(p.buy_fee)*parseInt(p.number);
			if(!isNaN(parseInt(p.number)))
				t_s+=parseInt(p.number);
			var c_p=parseFloat(p.sell_price);
			var t_c=buy_price*p.number+buy_fee;
			if(!isNaN(t_c))
				s_t_c+=t_c;
			var t_v=c_p*p.number-p.sell_fee;
			if(!isNaN(t_v))
				s_t_v+=t_v;
			var t_g=t_v-t_c;
			if(!isNaN(t_g))
				s_t_g+=t_g;
				
			var buy_time=new Date(parseInt(p.buy_time));
			buy_time=(buy_time.getDate()+1)+'/'+(buy_time.getMonth()+1)+'/'+buy_time.getFullYear();
			
			var sell_time=new Date(parseInt(p.sell_time));
			sell_time=(sell_time.getDate()+1)+'/'+(sell_time.getMonth()+1)+'/'+sell_time.getFullYear();			
			
			s_t_g_p=(s_t_g/s_t_c)*100;
			
			var bg;			
			if(t_g>0) bg='green'; else bg='red';
			
			html+='<tr class="'+bg+'"><td>'+p.symbol+'</br>'+p.number+'</td><td>'+buy_time+'</br>'+t_c.toFixed(2)+'</td><td>'+sell_time+'</br>'+t_v.toFixed(2)+'</td><td>'+t_g.toFixed(2)+'</td><td><input type="button" onclick="del_realized(this);" value="-" /></td></tr>';
		}
		html+='</table>';
		$("#divrealized").html(html);
		$("#page_realized .stat-box:eq(0) div").text(t_s);
		$("#page_realized .stat-box:eq(1) div").text(s_t_c.toFixed(2));
		$("#page_realized .stat-box:eq(2) div").text(s_t_v.toFixed(2));
		$("#page_realized .stat-box:eq(3) div").text(s_t_g.toFixed(2)+' ('+s_t_g_p.toFixed(2)+'%)');
	}	
	
	function del_share(){		
		var index=$("#divoptions").data("index");
		portfolio.splice(index,1);
		save_portfolio();		
		location.reload(false);
	}
	
	function del_realized(me){
		var tr=$(me).parent().parent();
		var index=$("#tblrealized tr").index(tr)-1;
		realized.splice(index,1);
		save_realized();		
		location.reload(false);
	}
	
	function sell_share(me){		
		var index=$("#divoptions").data("index");
		var item=portfolio[index];
		portfolio.splice(index,1);
		
		var sell_number=$("#divsell #number").val();
		item.number-=sell_number;
		
		portfolio.splice(index,0,item);
		save_portfolio();		
				
		item.number=sell_number;
		item.sell_time=new Date().getTime();
		item.sell_price=$("#divsell #price").val();
		item.sell_fee=$("#divsell #fee").val();
		
		realized.push(item);
		save_realized();
		
		location.reload(false);
	}	
	
	function show_sell_share(){
		var index=$("#divoptions").data("index");
		var item=portfolio[index];
		$('#divsell #symbol').val(item.symbol);
		$(".popup").hide();		
		$('#divsell').show();
	}
	
	function show_share_options(me){
		$(".popup").hide();
		var tr=$(me).parent().parent();
		var index=$("#tblportfolio tr").index(tr)-1;
		$("#divoptions").css({
			'margin-left': -$("#divoptions").width() / 2 + 'px',
			'margin-top': -$("#divoptions").height() / 2 + 'px'
		});
		$("#divoptions").data("index",index).show();
	}	
	</script>
	
	</head> 

<body> 
	<div class="page" id="page_portfolio">	
		<div id="divportfolio">
			Portfolio
		</div>
		<div class="stat-box">
			Total Share:<br/><div></div>
		</div>			
		<div class="stat-box">
			Subtotal Cost:<br/><div></div>
		</div>		
		<div class="stat-box">
			Subtotal Value:<br/><div></div>
		</div>		
		<div class="stat-box">
			Subtotal Gain:<br/><div></div>
		</div>
		<br class="clear"/>
		<input type="button" value="Show Realized Gain" onclick="$('.page').hide();$('#page_realized').show();" />		
	</div>
	<div class="page hidden" id="page_realized">	
		<div id="divrealized">
			Realized Gain
		</div>
		<div class="stat-box">
			Total Sold:<br/><div></div>
		</div>			
		<div class="stat-box">
			Subtotal Buy Cost:<br/><div></div>
		</div>		
		<div class="stat-box">
			Subtotal Sell Value:<br/><div></div>
		</div>		
		<div class="stat-box">
			Subtotal Realized Gain:<br/><div></div>
		</div>	
		<br class="clear"/>
		<input type="button" value="Show Portfolio" onclick="$('.page').hide();$('#page_portfolio').show();" />
	</div>	

	<div class="hidden popup popupmenu" id="divoptions" >
		<ul>
			<li onclick="show_sell_share();">Sell</li>
			<li onclick="del_share();">Delete</li>
			<li onclick="$(this).parent().parent().hide();">Cancel</li>
		</ul>
	</div>		
	
	<div class="hidden popup popupwin" id="divbuy">
		<form id="frmbuy" onsubmit="return buy_share(this);" method="post">
		<table width="95%">
			<tr>
				<td>Symbol/Trade Code:</td>
				<td>
					<select name="symbol" id="symbol" required="required">
					</select>
				</td>
			</tr>
			<tr>
				<td>Buy Quantity:</td>
				<td><input type="text" name="number" id="number" required="required"></input></td>
			</tr>
			<tr>
				<td>Buy Price:</td>
				<td><input type="text" name="price" id="price" required="required"/></td>
			</tr>	
			<tr>
				<td>Buy Fee:</td>
				<td><input type=""text"" name="fee" id="fee" required="required"/></td>
			</tr>	
			<tr>
				<td><input type="button" onclick="$('#divbuy').hide()" value="Cancel" /></td>
				<td><input type="submit" value="Buy"/></td>
			</tr>												
		</table>
		</form>
	</div>	
	
	<div class="hidden popup popupwin" id="divsell">
		<form id="frmsell" onsubmit="return sell_share(this);" method="post">
		<table width="95%">
			<tr>
				<td>Symbol/Trade Code:</td>
				<td><input type="text" disabled="disabled" name="symbol" id="symbol" required="required"/></td>
			</tr>
			<tr>
				<td>Sell Quantity:</td>
				<td><input type="text" name="number" id="number" required="required"></input></td>
			</tr>
			<tr>
				<td>Sell Price:</td>
				<td><input type="text" name="price" id="price" required="required"/></td>
			</tr>	
			<tr>
				<td>Sell Fee:</td>
				<td><input type=""text"" name="fee" id="fee" required="required"/></td>
			</tr>	
			<tr>
				<td><input type="button" onclick="$('#divsell').hide()" value="Cancel" /></td>
				<td><input type="submit" value="Sell"/></td>
			</tr>												
		</table>
		</form>
	</div>	
</body>
</html>
